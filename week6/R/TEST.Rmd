---
title: "Ubiqum: week 6 - Market basket analysis"
author: "Blackwell data department _ Toine"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
---

# Executive summary

This memo investigates whether Electronidex presents a good acquisition opportunity for Blackwell. To that end, it analyses the limited transaction data we have received from Electronidex as part of the due dilligence.

The most important findings and recommendations:

## General recommendations

* The amount of data covers only one month of transactions. Therefore, it is impossible to correct for seasonality. Moreover, the target company may have boosted the numbers (e.g. by having aggressive promotions, by delaying sales to clients to this month, etc.). We should request addition data to be made available to us.
* The data does not contains actual sales volume figures. Hence, it is hard to compare their sales figures to ours. However, it is clear that the most sold products are both desktops and laptops, something which we are not strong in.

## Observations from data

* 

```{r Setup, results = "hide", message = FALSE, warning = FALSE}
## Load libraries =================================
library(arulesViz)
library(arules)

## Prepare clusters =================================
#cl <- makeCluster(3)
#registerDoParallel(cl)
```

# Methodology

```{r Create corporate flag variable, results = "hide", message = FALSE, warning = FALSE}
## Create category variable which shows whether transaction is corporate or not (with dataframe) #######
df <- readr::read_csv('../input/ElectronidexTransactions2017.csv', col_names = F, trim_ws = T)

#Initialize category variable
corporation <- logical(dim(df)[1])

computers <- c(
  "LG Touchscreen Laptop",
  "Acer Aspire",
  "HP Laptop",
  "ASUS Chromebook",
  "Apple MacBook Pro",
  "Apple MacBook Air",
  "Dell Laptop",
  "Eluktronics Pro Gaming Laptop",
  "Alienware Laptop",
  "HP Notebook Touchscreen Laptop PC",
  "Lenovo Desktop Computer",
  "iMac",
  "HP Desktop",
  "ASUS Desktop",
  "Dell Desktop",
  "Intel Desktop",
  "Acer Desktop",
  "CYBERPOWER Gamer Desktop"
)

#Run in a loop over all transactions, and flag corporation TRUE if a transaction has >1 computer
for (i in 1:length(corporation)) {
  compcount <- 0
  for (j in 1:length(df[i,])) {
    if (df[i,j] %in% computers) {
      compcount <- compcount + 1
      if (compcount > 1) {
        corporation[i] <- TRUE; break
      }
    }
  }
}

#Code to screen for MS office in transaction  
# if (elecTransactions[i]@data[97]) {
#   category[i] <- "PrivateIndividual"    
# }

## Create new dataset with categories instead of products ====================================

cateTrans <- readr::read_csv('../input/ElectronidexTransactions2017.csv', col_names = F, trim_ws = T)

laptops <- c(
  "LG Touchscreen Laptop",
  "Acer Aspire",
  "HP Laptop",
  "ASUS Chromebook",
  "Apple MacBook Pro",
  "Apple MacBook Air",
  "Dell Laptop",
  "Eluktronics Pro Gaming Laptop",
  "Alienware Laptop",
  "HP Notebook Touchscreen Laptop PC"
  )

desktops <- c(
  "Lenovo Desktop Computer",
  "iMac",
  "HP Desktop",
  "ASUS Desktop",
  "Dell Desktop",
  "Intel Desktop",
  "Acer Desktop",
  "CYBERPOWER Gamer Desktop"
  )

monitors <- c(
  "Acer Monitor",
  "LG Monitor",
  "ASUS Monitor",
  "ASUS 2 Monitor",
  "Dell Monitor",
  "Samsung Monitor",
  "Sceptre Monitor",
  "ViewSonic Monitor",
  "AOC Monitor",
  "HP Monitor"
  )

iodevices <- c(
  "3-Button Mouse",
  "Logitech Wireless Mouse",
  "Microsoft Basic Optical Mouse",
  "Logitech 3-button Mouse",
  "Redragon Gaming Mouse  ",
  "HP Wireless Mouse",
  "Generic Black 3-Button",
  "Wireless Portable Mouse",
  "Gaming Mouse Professional",
  "Slim Wireless Mouse",
  "HP USB Keyboard",
  "Logitech Wireless Keyboard",
  "Rii LED Keyboard",
  "Logitech Keyboard",
  "Backlit LED Gaming Keyboard",
  "Dell Wired Keyboard",
  "Apple Wired Keyboard",
  "Apple Wireless Keyboard",
  "Apple Magic Keyboard",
  "Logitech MK550 Wireless Wave Keyboard and Mouse Combo",
  "Logitech Desktop MK120 Mouse and keyboard Combo",
  "Logitech MK270 Wireless Keyboard and Mouse Combo",
  "Dell KM117 Wireless Keyboard & Mouse",
  "EagleTec Wireless Combo Keyboard and Mouse",
  "Microsoft Wireless Comfort Keyboard and Mouse",
  "Microsoft Wireless Desktop Keyboard and Mouse",
  "Rii LED Gaming Keyboard & Mouse Combo",
  "Logitech MK360 Wireless Keyboard and Mouse Combo"
)

for (i in seq_along(laptops)){
  cateTrans[cateTrans == laptops[i]] <- "Laptop"
}

for (i in seq_along(desktops)){
  cateTrans[cateTrans == desktops[i]] <- "Desktop"
}

for (i in seq_along(monitors)){
  cateTrans[cateTrans == monitors[i]] <- "Monitor"
}

for (i in seq_along(iodevices)){
  cateTrans[cateTrans == iodevices[i]] <- "I/O-device"
}

readr::write_csv(df, '../input/replaced.csv', na="", col_names = F)

## Import dataset =================================
elecTransactions <- read.transactions('../input/replaced.csv', sep = ',', rm.duplicates = F, format = "basket")
#elecTransactions <- read.transactions('../input/ElectronidexTransactions2017.csv', sep = ',', rm.duplicates = F, format = "basket")
```

This is a test

```{r Data exploration, message = FALSE, warning = FALSE}
## Explore dataset =================================
length(elecTransactions) #provides total amount of observations
size(elecTransactions) # provides vector with number of items per observation
LIST(elecTransactions) #Lists the transactions by conversion (LIST must be capitalized)
itemLabels(elecTransactions) # To see the item labels
summary(elecTransactions)

## Visualize dataset ===============================
#Visualization of most commonly bought items
itemFrequencyPlot(elecTransactions, topN = "15",
                  type="absolute",
                  horiz = T,
                  main="Absolute Item Frequency Plot"
                  )

#Visualization of transactions
arules::image(elecTransactions,
              xlab = "Items (Columns)",
              ylab = "Transactions (Rows)")

#Find out most sold items in transactions with only one item
oneItemSales <- subset(elecTransactions, size(elecTransactions) == 1)
itemFrequencyPlot(oneItemSales, topN = "15",
                  type="absolute",
                  horiz = T,
                  main="Absolute Item Frequency Plot"
                  )

#Find out average number of different items in transaction
mean(size(elecTransactions))

#Visualization of sample of transactions
image(sample(elecTransactions, 200))

## Building of the model ====================================
rules <- apriori(elecTransactions, 
                 parameter = list(support = 0.05, confidence = 0.5, minlen = 2)
                )
inspect(sort(rules, by = "lift"))
plot(rules, method = "graph", shading = NA)


## Digging into Laptops =====================================
rules1 <- apriori(elecTransactions, 
                 parameter = list(support = 0.01, confidence = 0.2, minlen = 2),
                 appearance = list(default="rhs", lhs="Laptop")
                  )
inspect(sort(rules1, by = "lift"))
plot(rules1, method = "graph", shading = NA)

## Digging into Desktops =====================================
rules1 <- apriori(elecTransactions, 
                  parameter = list(support = 0.01, confidence = 0.2, minlen = 2),
                  appearance = list(default="rhs", lhs="Desktop")
)
inspect(sort(rules1, by = "lift"))
plot(rules1, method = "graph", shading = NA)

## Digging into Monitors =====================================
rules1 <- apriori(elecTransactions, 
                  parameter = list(support = 0.01, confidence = 0.2, minlen = 2),
                  appearance = list(default="rhs", lhs="Laptop")
)
inspect(sort(rules1, by = "lift"))
plot(rules1, method = "graph", shading = NA)


## Split transaction data into corporation and private individuals
elecTrans_corp<-elecTransactions[corporation]
elecTrans_private<-elecTransactions[!corporation]

rules <- apriori(elecTrans_corp, 
                 parameter = list(support = 0.05, confidence = 0.5, minlen = 2)
                )
inspect(sort(rules, by = "lift"))
plot(rules, method = "graph", shading = NA)

rules <- apriori(elecTrans_private, 
                 parameter = list(support = 0.01, confidence = 0.5, minlen = 2)
)
inspect(sort(rules, by = "count"))
plot(rules, method = "graph", shading = NA)
```

Rules for determining whether a transaction what from a corporation or private individual:


Given that both laptops and desktops can be considered the main products in a purchase, these are removed from the rhs side of rules.
